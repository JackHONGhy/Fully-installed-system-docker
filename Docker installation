#!/usr/bin/env bash
set -euo pipefail

echo "ğŸš€ æ£€æµ‹ç³»ç»Ÿç±»å‹..."
if [[ -f /etc/os-release ]]; then
  . /etc/os-release
  OS="${ID:-}"
  LIKE="${ID_LIKE:-}"
else
  echo "âŒ æ— æ³•è¯†åˆ«ç³»ç»Ÿç±»å‹ï¼Œè¯·æ‰‹åŠ¨å®‰è£… Dockerã€‚"
  exit 1
fi

# å…è®¸åœ¨ root ç¯å¢ƒä¸‹æ²¡æœ‰ sudo çš„æƒ…å†µ
if command -v sudo >/dev/null 2>&1; then
  SUDO="sudo"
else
  SUDO=""
fi

echo "ğŸ§© ç³»ç»Ÿæ£€æµ‹ç»“æœ: OS=${OS:-unknown}, ID_LIKE=${LIKE:-none}"

# === å…¬ç½‘ IP åœ°ç†ä½ç½®æ¢æµ‹ï¼ˆæ˜¯å¦åœ¨ä¸­å›½ï¼‰ =========================================
detect_country() {
  for url in \
    "https://ipinfo.io/country" \
    "https://ifconfig.co/country" \
    "https://ipapi.co/country" \
    "https://ip.sb/country"
  do
    code="$(curl -fsSL --max-time 2 "$url" 2>/dev/null || true)"
    code="$(printf "%s" "$code" | head -n1 | tr -d ' \r\n' )"
    if [[ -n "$code" ]]; then
      echo "$code"
      return 0
    fi
  done

  txt="$(curl -fsSL --max-time 2 "https://cip.cc" 2>/dev/null || true)"
  if echo "$txt" | grep -q "ä¸­å›½"; then
    echo "CN"
    return 0
  fi

  echo ""
  return 1
}

COUNTRY="$(detect_country || true)"
IN_CN=0
if [[ "${COUNTRY^^}" == "CN" ]]; then
  IN_CN=1
  echo "ğŸŒ åœ°ç†ä½ç½®åˆ¤æ–­ï¼šæ£€æµ‹åˆ°ä¸­å›½å¢ƒå†…ï¼ˆcountry=$COUNTRYï¼‰ï¼Œå°†ä½¿ç”¨æ¸…å TUNA çš„ Docker CE æºã€‚"
else
  echo "ğŸŒ åœ°ç†ä½ç½®åˆ¤æ–­ï¼šæœªæ£€æµ‹åˆ°ä¸­å›½å¢ƒå†…ï¼ˆcountry=${COUNTRY:-unknown}ï¼‰ï¼Œå°†ä½¿ç”¨ Docker å®˜æ–¹æºã€‚"
fi

# === å½’ç±»å®¶æ—ï¼šdebian / rhel / fedora ==========================================
FAMILY=""
case "$OS $LIKE" in
  *ubuntu*|*debian*|*Debian*|*Ubuntu*)
    FAMILY="debian"
    ;;
  *fedora*)
    FAMILY="fedora"
    ;;
  *rhel*|*centos*|*rocky*|*almalinux*|*ol*)
    FAMILY="rhel"
    ;;
  *)
    if [[ "${LIKE,,}" == *debian* ]]; then FAMILY="debian"; fi
    if [[ -z "$FAMILY" && "${LIKE,,}" == *rhel* ]]; then FAMILY="rhel"; fi
    if [[ -z "$FAMILY" && "${LIKE,,}" == *fedora* ]]; then FAMILY="fedora"; fi
    ;;
esac

if [[ -z "$FAMILY" ]]; then
  echo "âŒ æš‚ä¸æ”¯æŒçš„ç³»ç»Ÿ: OS=$OS, ID_LIKE=$LIKEï¼Œè¯·æ‰‹åŠ¨å®‰è£… Dockerã€‚"
  exit 1
fi

# === å…ˆå°½é‡ç§»é™¤æ—§ç‰ˆæœ¬ï¼ˆå®¹é”™ï¼‰ ====================================================
$SUDO sh -c 'apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true' || true
$SUDO sh -c 'yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine 2>/dev/null || true' || true
$SUDO sh -c 'dnf remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine 2>/dev/null || true' || true

# === å®‰è£… Dockerï¼ˆæ ¹æ®å®¶æ— & æ˜¯å¦åœ¨ä¸­å›½åˆ‡æºï¼‰ ====================================
case "$FAMILY" in
  debian)
    echo "ğŸ“¦ ä¸º Debian/Ubuntu ç³»å®‰è£… Docker..."
    $SUDO apt-get update -y
    $SUDO apt-get install -y ca-certificates curl gnupg lsb-release
    $SUDO install -m 0755 -d /etc/apt/keyrings

    APT_BASE="$OS"
    if [[ "$OS" != "ubuntu" && "$OS" != "debian" ]]; then
      APT_BASE="debian"
    fi

    if [[ "$IN_CN" -eq 1 ]]; then
      curl -fsSL "https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/${APT_BASE}/gpg" \
        | $SUDO gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      $SUDO chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/${APT_BASE} $(lsb_release -cs) stable" \
        | $SUDO tee /etc/apt/sources.list.d/docker.list >/dev/null
    else
      curl -fsSL "https://download.docker.com/linux/${APT_BASE}/gpg" \
        | $SUDO gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      $SUDO chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/${APT_BASE} $(lsb_release -cs) stable" \
        | $SUDO tee /etc/apt/sources.list.d/docker.list >/dev/null
    fi

    $SUDO apt-get update -y
    $SUDO apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    ;;
  rhel)
    echo "ğŸ“¦ ä¸º RHEL/CentOS/Alma/Rocky ç³»å®‰è£… Docker..."
    if command -v dnf >/dev/null 2>&1; then
      $SUDO dnf -y install dnf-plugins-core
      BASE_OS_REPO="centos"
      [[ "$OS" == "rhel" ]] && BASE_OS_REPO="rhel"
      $SUDO dnf config-manager --add-repo "https://download.docker.com/linux/${BASE_OS_REPO}/docker-ce.repo"

      if [[ "$IN_CN" -eq 1 ]]; then
        $SUDO sed -i 's+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+g' /etc/yum.repos.d/docker-ce.repo
      fi

      $SUDO dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    else
      $SUDO yum install -y yum-utils
      BASE_OS_REPO="centos"
      [[ "$OS" == "rhel" ]] && BASE_OS_REPO="rhel"
      $SUDO yum-config-manager --add-repo "https://download.docker.com/linux/${BASE_OS_REPO}/docker-ce.repo"

      if [[ "$IN_CN" -eq 1 ]]; then
        $SUDO sed -i 's+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+g' /etc/yum.repos.d/docker-ce.repo
      fi

      $SUDO yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    fi
    ;;
  fedora)
    echo "ğŸ“¦ ä¸º Fedora å®‰è£… Docker..."
    $SUDO dnf -y install dnf-plugins-core
    $SUDO dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

    if [[ "$IN_CN" -eq 1 ]]; then
      $SUDO sed -i 's+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+g' /etc/yum.repos.d/docker-ce.repo
    fi

    $SUDO dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    ;;
esac

# === å¯åŠ¨ & è‡ªå¯ ===============================================================
if command -v systemctl >/dev/null 2>&1; then
  $SUDO systemctl enable docker || true
  $SUDO systemctl start docker || true
else
  echo "â„¹ï¸ å½“å‰ç¯å¢ƒæ²¡æœ‰ systemdï¼ˆå¯èƒ½æ˜¯å®¹å™¨/WSLï¼‰ã€‚å·²è·³è¿‡ systemctl æ“ä½œã€‚"
fi

echo "âœ… Docker å·²å®‰è£…å®Œæˆï¼ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š"
docker --version || (echo "âš ï¸ 'docker' å¯èƒ½æœªåœ¨ PATH æˆ–éœ€è¦é‡æ–°ç™»å½• shellã€‚"; true)
echo "âœ… Docker Compose æ’ä»¶ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š"
docker compose version || (echo "âš ï¸ 'docker compose' å¯èƒ½æœªåœ¨ PATH æˆ–éœ€è¦é‡æ–°ç™»å½• shellã€‚"; true)

# === æ–°å¢ï¼šç‹¬ç«‹ç‰ˆ docker-compose å®‰è£… ==========================================
if ! command -v docker-compose >/dev/null 2>&1; then
  echo "ğŸ“¦ å®‰è£…ç‹¬ç«‹ç‰ˆ docker-compose..."
  COMPOSE_VERSION="$(curl -fsSL https://api.github.com/repos/docker/compose/releases/latest | grep tag_name | cut -d '"' -f4)"
  if [[ "$IN_CN" -eq 1 ]]; then
    DOWNLOAD_URL="https://mirror.ghproxy.com/https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)"
  else
    DOWNLOAD_URL="https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)"
  fi
  $SUDO curl -L "$DOWNLOAD_URL" -o /usr/local/bin/docker-compose
  $SUDO chmod +x /usr/local/bin/docker-compose
  echo "âœ… ç‹¬ç«‹ç‰ˆ docker-compose å·²å®‰è£…å®Œæˆï¼ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š"
  docker-compose --version || echo "âš ï¸ docker-compose å¯èƒ½æœªåœ¨ PATHï¼Œè¯·æ£€æŸ¥ /usr/local/bin/"
else
  echo "âœ… å·²æ£€æµ‹åˆ° docker-composeï¼Œè·³è¿‡å®‰è£…ã€‚"
fi

# === å°†ç”¨æˆ·åŠ å…¥ docker ç»„ ======================================================
if getent group docker >/dev/null 2>&1; then
  if [[ "${EUID:-$(id -u)}" -ne 0 && -n "${USER:-}" ]]; then
    echo "ğŸ‘¤ å¯é€‰ï¼šå°†ç”¨æˆ· ${USER} åŠ å…¥ docker ç»„ä»¥æ—  sudo ä½¿ç”¨ docker"
    $SUDO usermod -aG docker "$USER" || true
    echo "â„¹ï¸ åŠ å…¥ç”¨æˆ·ç»„åéœ€é‡æ–°ç™»å½•ç»ˆç«¯æˆ–æ‰§è¡Œ 'newgrp docker' ç”Ÿæ•ˆã€‚"
  fi
fi

# === ç®€å•éªŒè¯ =================================================================
if command -v docker >/dev/null 2>&1; then
  echo "ğŸ§ª è¿›è¡Œ hello-world æµ‹è¯•ï¼ˆå¯è·³è¿‡å¤±è´¥ï¼Œä¸ä¸­æ–­ï¼‰..."
  $SUDO docker run --rm hello-world || true
fi

echo "ğŸ‰ å…¨éƒ¨å®Œæˆï¼"
